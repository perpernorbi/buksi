<!DOCTYPE html>

<meta charset="utf-8" />

<title>WebSocket Test</title>

<script language="javascript" type="text/javascript">

  var wsUri = "ws://"+window.location.host+"/drive-ws.cgi";

  var output;

  function init()
  {
    output = document.getElementById("output");
    testWebSocket();
  }

  function testWebSocket()
  {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
    writeToScreen("CONNECTED");
    doSend("s");
  }

  function onClose(evt)
  {
    writeToScreen("DISCONNECTED");
  }

  function onMessage(evt)
  {
    writeToScreen('<span style="color: blue;">RECEIVED: ' + evt.data+'</span>');
//    websocket.close();
  }

  function onError(evt)
  {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend(message)
  {
    writeToScreen("SENT: " + message);
    websocket.send(message);
  }

  function writeToScreen(message)
  {
    output.innerHTML = "<p>" + message + "</p>";
  }

  window.addEventListener("load", init, false);

</script>

<style>
#joystick {
    width		: 100%;
    height		: 600px;
    padding		: 0;
    margin		: 0;
    -webkit-user-select	: none;
    -moz-user-select	: none;
    background-color: lightgray;
}
</style>

<h2>WebSocket Test</h2>
 <button onclick="doSend('s')">Stop</button>
 <button onclick="doSend('f')">Forward</button>
 <button onclick="doSend('b')">Backward</button>
 <button onclick="doSend('l')">Left</button>
 <button onclick="doSend('r')">Right</button>
<div id="joystick"></div>
<div id="result"></div>

<script src="virtualjoystick.js"></script>
<script>
 var stopMessage = {"drive_mode": "direct", "velocities": [0,0] };
 console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");

 var joystick	= new VirtualJoystick({
  container	: document.getElementById('joystick'),
  mouseSupport	: true,
 });
 joystick.addEventListener('touchStart', function(){
  console.log('down')
 })
 joystick.addEventListener('touchEnd', function(){
  console.log('up')
  doSend(JSON.stringify(stopMessage))
 })

 setInterval(function(){
  //if (joystick.right()) doSend('r')
  //if (joystick.left()) doSend('l')
  //if (joystick.up()) doSend('f')
  //if (joystick.down()) doSend('b')
  var message = stopMessage;
  var x = joystick.deltaX()/12;
  var y = joystick.deltaY()/12;
  var l = - x - y;
  var r = x - y;
  if (l > 31) l = 31;
  if (l < -31) l = -31;
  if (r > 31) r = 31;
  if (r < -31) r = -31;
  message.velocities[0] = Math.round(l);
  message.velocities[1] = Math.round(r);
  doSend(JSON.stringify(message))

  var outputEl	= document.getElementById('result');
                outputEl.innerHTML	= '<b>Result:</b> '
                    + ' dx:'+joystick.deltaX()
                    + ' dy:'+joystick.deltaY()
                    + (joystick.right()	? ' right'	: '')
                    + (joystick.up()	? ' up'		: '')
                    + (joystick.left()	? ' left'	: '')
                    + (joystick.down()	? ' down' 	: '')
            }, 50);
        </script>
<div id="output"></div>
